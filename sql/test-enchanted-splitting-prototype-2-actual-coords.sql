-- Prototype 2: Actual Coordinates from public.trails with Preprocessing
-- Uses the actual coordinates from the database and applies preprocessing to get same results as prototype 1

WITH 
-- Get the actual coordinates from public.trails
actual_enchanted_mesa AS (
  SELECT ST_GeomFromText('LINESTRING(-105.281535350443 39.9949679154383,-105.28145568474 39.9950111396921,-105.281022851303 39.9951563466367,-105.280707529117 39.995391365347,-105.280508719401 39.9954729348033,-105.280274656025 39.995527559796,-105.279583662378 39.9955652678396,-105.278752501151 39.9957024166702,-105.278611821383 39.9956757255476,-105.278517887753 39.9956218925555,-105.278270791605 39.9953521931913,-105.278140619639 39.9950281530965,-105.278140217597 39.9949290454338,-105.278186672002 39.994829826218,-105.278279909511 39.9947124750807,-105.279015696172 39.9941701185238,-105.279260737199 39.9939352737226,-105.279669476211 39.9936279551608,-105.280312525396 39.9933290785085,-105.280663387762 39.9931930824973,-105.281049464002 39.9930750196324,-105.281119488281 39.9930117812441,-105.281457043419 39.992488392953,-105.28165525008 39.9922626674532,-105.281666705859 39.992199571035,-105.281690057975 39.9921814937888,-105.281688837774 39.9918841743404,-105.281756711936 39.9912983724889,-105.281706972124 39.9905957290597,-105.281718389401 39.9905236229124,-105.281788188336 39.990406325844,-105.281764132308 39.9902532168232,-105.281869033773 39.9901268245633,-105.281880561906 39.9900817475262,-105.281891349323 39.9898564771773,-105.281855246767 39.989622310149,-105.281889903794 39.9895050975508,-105.282029833429 39.9893515905319,-105.282087176301 39.9890541275319,-105.2821680931 39.9887926463124,-105.2822613168 39.988675291899,-105.28233137258 39.9886210624623,-105.282396364737 39.9885958676962,-105.282424928528 39.9885847953298,-105.2826472523 39.9885301945836,-105.282857975343 39.9885026502285,-105.28310394886 39.9885020506077,-105.283384875292 39.9884563160005,-105.283595076208 39.988302634342,-105.28415625444 39.9880489854603,-105.284331500386 39.987940438065,-105.284389728774 39.9878592069818,-105.284447696624 39.9877149087827,-105.284494323928 39.9876607346238,-105.28462290269 39.987597350335,-105.284716532003 39.9875791016778,-105.285360813351 39.9875955360015,-105.285645475611 39.9875739690295)') AS geom
),
actual_enchanted_kohler AS (
  SELECT ST_GeomFromText('LINESTRING(-105.280213207035 39.9879240388307,-105.280329702179 39.987926507836,-105.280452206704 39.9878990433279,-105.280589416236 39.9878848857127,-105.280674253498 39.987891689037,-105.280816471857 39.987867043325,-105.280881215825 39.9878742348463,-105.281039117155 39.9878554288519,-105.281201826372 39.9878491373089,-105.281358168621 39.9878860224586,-105.281479066952 39.9878748613017,-105.281601325488 39.9878754842405,-105.281647677757 39.9878649977304,-105.281702217212 39.9878421983277,-105.281749073183 39.9878360082293,-105.281859418821 39.9878398853626,-105.281926974093 39.987857927178,-105.282005473871 39.9878659531571,-105.282024957713 39.9878751606222,-105.282036651312 39.9878983468298,-105.282060275874 39.9879927445213,-105.282056377387 39.9880362263105,-105.282077510213 39.98810232396,-105.282083609054 39.9881905655479,-105.28210867091 39.9882391016301,-105.282114053843 39.9883050628127,-105.282124390771 39.9883349862385,-105.282185336686 39.9884073505761,-105.282256656506 39.9884334765379,-105.282313374323 39.988469733506,-105.282386771794 39.988580539265)') AS geom
),
-- Step 1: Simplify the geometries to reduce precision (like prototype 1)
simplified_mesa AS (
  SELECT ST_Simplify(geom, 0.000001) AS geom FROM actual_enchanted_mesa
),
simplified_kohler AS (
  SELECT ST_Simplify(geom, 0.000001) AS geom FROM actual_enchanted_kohler
),
-- Step 2: Snap them with a tolerance (1e-6 ~ 0.1m at this latitude) - EXACT SAME LOGIC AS PROTOTYPE 1
snapped AS (
  SELECT 
    ST_Snap(sm.geom, sk.geom, 1e-6) AS enchanted_mesa_geom,
    ST_Snap(sk.geom, sm.geom, 1e-6) AS enchanted_kohler_geom
  FROM simplified_mesa sm, simplified_kohler sk
),
-- Step 3: get intersection points - EXACT SAME LOGIC AS PROTOTYPE 1
ix AS (
  SELECT (ST_Dump(ST_Intersection(enchanted_mesa_geom, enchanted_kohler_geom))).geom AS pt
  FROM snapped
),
-- Step 4: split both lines at intersection points - EXACT SAME LOGIC AS PROTOTYPE 1
split_enchanted_mesa AS (
  SELECT (ST_Dump(ST_Split(enchanted_mesa_geom, pt))).geom AS geom
  FROM snapped, ix
),
split_enchanted_kohler AS (
  SELECT (ST_Dump(ST_Split(enchanted_kohler_geom, pt))).geom AS geom
  FROM snapped, ix
)
-- final union of split trail segments - EXACT SAME LOGIC AS PROTOTYPE 1
SELECT 'Enchanted Mesa Trail (Actual Coords - Simplified)' AS trail_name, geom, ST_Length(geom::geography) as length_meters FROM split_enchanted_mesa
UNION ALL
SELECT 'Enchanted-Kohler Spur Trail (Actual Coords - Simplified)' AS trail_name, geom, ST_Length(geom::geography) as length_meters FROM split_enchanted_kohler
ORDER BY trail_name, length_meters DESC;
